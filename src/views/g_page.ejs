<!DOCTYPE html>
<html lang="en">
  <!-- Header -->
  <%- include('layouts/header'); -%>
  <body>
    <!-- Navbar -->
    <%- include('layouts/navbar'); -%>

    <!-- Main Content -->

    <main class="g-page-main-div-style">
      <div class="background-container">
        <div class="overlay-style"></div>
        <div class="content-wrapper">
          <!-- Introductory Text -->
          <div class="intro-text">
            <% if (loggedIn) { %>
            <h1>Hello <%= username %></h1>
            <% } %>
            <h2>Welcome to the G Test Data Retrieval Portal</h2>
          </div>
        </div>
      </div>
      <div class="g-page-container">
        <div class="g-page-form-container">
          <h2 class="text-center">Your Information</h2>

          <% if (user && user.licenseNumber !== "default") { %>
          <p class="pb-2">
            <strong>Name:</strong> <%= user.firstName %> <%= user.lastName %>
          </p>
          <p class="pb-2">
            <strong>License Number:</strong> <%= user.licenseNumber %>
          </p>
          <p class="pb-2"><strong>Age:</strong> <%= user.age %></p>
          <p class="pb-2">
            <strong>Date of Birth:</strong> <%= formattedDob %>
          </p>

          <!-- <h2 class="text-center mt-4">Your Car Information</h2>
          <p class="pb-2"><strong>Make:</strong> <%= user.car_details.make || 'N/A' %></p>
          <p class="pb-2"><strong>Model:</strong> <%= user.car_details.model || 'N/A' %></p>
          <p class="pb-2"><strong>Year:</strong> <%= user.car_details.year || 'N/A' %></p>
          <p class="pb-2"><strong>Plate Number:</strong> <%= user.car_details.plateNumber || 'N/A' %></p> -->

          <h2 class="text-center mt-4">Update Car Information</h2>
          <form id="gForm" action="/g" method="POST">
            <label for="carMake">Make:</label>
            <input
              type="text"
              id="carMake"
              name="make"
              value="<%= user.car_details.make || '' %>"
              required
            />

            <label for="carModel" class="mt-3">Model:</label>
            <input
              type="text"
              id="carModel"
              name="model"
              value="<%= user.car_details.model || '' %>"
              required
            />

            <label for="carYear" class="mt-3">Year:</label>
            <input
              type="text"
              id="carYear"
              name="year"
              value="<%= user.car_details.year || '' %>"
              required
            />

            <label for="carplateNumber" class="mt-3">Plate Number:</label>
            <input
              type="text"
              id="carplateNumber"
              name="plateNumber"
              value="<%= user.car_details.plateNumber || '' %>"
              required
            />

            <div class="d-flex align-items-center justify-content-center mt-4">
              <button type="submit" class="button">Update Information</button>
            </div>
          </form>
          <% } else { %>
          <!-- Show message to fill out the G2 form if user data is default -->
          <h4 class="text-center">
            Please fill out the G2 form to view your information.
          </h4>
          <% } %>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <%- include('layouts/footer'); -%> <%- include('layouts/scripts'); -%>
  </body>

  <script>
    // Function to format license number with dashes
    function formatLicenseNumber(input) {
      const cleaned = input.value.replace(/[^A-Za-z0-9]/g, "");

      let formatted = cleaned;

      if (cleaned.length > 5) {
        formatted = cleaned.slice(0, 5) + "-" + cleaned.slice(5);
      }
      if (cleaned.length > 11) {
        formatted = formatted.slice(0, 11) + "-" + formatted.slice(11);
      }

      input.value = formatted;
    }

    // Event listener for input formatting
    const licenseNumberInput = document.getElementById("licenseNumber");

    licenseNumberInput.addEventListener("input", function () {
      formatLicenseNumber(licenseNumberInput);
    });

    document.addEventListener("DOMContentLoaded", () => {
      const gPageForm = document.getElementById("gPageForm");

      gPageForm.addEventListener("submit", function (e) {
        let isValid = true;

        const clearErrors = () => {
          document.querySelectorAll(".error-message").forEach((error) => {
            error.textContent = "";
          });
        };

        clearErrors();

        const ontarioLicensePattern = /^[A-Za-z]\d{4}-\d{5}-\d{5}$/;
        const licenseNumber = document.getElementById("licenseNumber");

        const alphanumericOnly = licenseNumber.value.replace(
          /[^A-Za-z0-9]/g,
          ""
        );
        const alphanumericLength = alphanumericOnly.length;

        // Validate alphanumeric length
        if (alphanumericLength < 15) {
          document.getElementById("licenseError").textContent =
            "License number must contain 15 alphanumeric characters.";
          isValid = false;
        } else if (!ontarioLicensePattern.test(licenseNumber.value)) {
          document.getElementById("licenseError").textContent =
            "License number must be in the format: A1234-56789-12345.";
          isValid = false;
        }

        if (!isValid) {
          e.preventDefault();
        }
        // else {
        //   alert("Your request has been submitted successfully!");
        // }
      });
    });
  </script>
</html>
